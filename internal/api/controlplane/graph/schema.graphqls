# Gateway Control Plane GraphQL Schema
# This schema is the single source of truth for both Go and TypeScript types.

scalar Time
scalar JSON
scalar Int64

# =============================================================================
# Query Root
# =============================================================================

type Query {
  """Runtime statistics for the gateway"""
  stats: Stats!
  
  """Gateway configuration overview"""
  overview: Overview!
  
  """List interactions with optional filtering"""
  interactions(
    filter: InteractionFilter
    limit: Int = 50
    offset: Int = 0
  ): InteractionConnection!
  
  """Get a single interaction by ID"""
  interaction(id: ID!): Interaction
  
  """Get events for an interaction"""
  interactionEvents(interactionId: ID!, limit: Int = 500): InteractionEventsResponse!
  
  """Get shadow results for an interaction"""
  shadowResults(interactionId: ID!): ShadowResultsResponse!
  
  """List interactions with divergent shadow results"""
  divergentShadows(
    limit: Int = 100
    offset: Int = 0
    provider: String
  ): DivergentShadowsResponse!
  
  """Get a single shadow result by ID"""
  shadow(id: ID!): ShadowResult
}

# =============================================================================
# Stats Types
# =============================================================================

type Stats {
  uptime: String!
  goVersion: String!
  numGoroutine: Int!
  memory: MemoryStats!
}

type MemoryStats {
  alloc: Int64!
  totalAlloc: Int64!
  sys: Int64!
  numGC: Int!
}

# =============================================================================
# Overview Types
# =============================================================================

type Overview {
  mode: String!
  storage: StorageSummary!
  apps: [AppSummary!]!
  frontdoors: [FrontdoorSummary!]!
  providers: [ProviderSummary!]!
  routing: RoutingSummary!
  tenants: [TenantSummary!]!
}

type StorageSummary {
  enabled: Boolean!
  type: String!
  path: String
}

type AppSummary {
  name: String!
  frontdoor: String!
  path: String!
  provider: String
  defaultModel: String
  enableResponses: Boolean!
  modelRouting: ModelRoutingSummary
}

type ModelRoutingSummary {
  prefixProviders: JSON
  rewrites: [ModelRewriteSummary!]
}

type ModelRewriteSummary {
  modelExact: String
  modelPrefix: String
  provider: String!
  model: String!
}

type FrontdoorSummary {
  type: String!
  path: String!
  provider: String
  defaultModel: String
}

type ProviderSummary {
  name: String!
  type: String!
  baseUrl: String
  supportsResponses: Boolean!
  enablePassthrough: Boolean!
}

type RoutingSummary {
  defaultProvider: String!
  rules: [RoutingRule!]!
}

type RoutingRule {
  modelPrefix: String
  modelExact: String
  provider: String!
}

type TenantSummary {
  id: ID!
  name: String!
  providerCount: Int!
  routingRules: Int!
  supportsTenant: Boolean!
}

# =============================================================================
# Interaction Types
# =============================================================================

input InteractionFilter {
  """Filter by frontdoor type (openai, anthropic, responses)"""
  frontdoor: String
  """Filter by provider name"""
  provider: String
  """Filter by status"""
  status: String
}

type InteractionConnection {
  interactions: [InteractionSummary!]!
  total: Int!
}

type InteractionSummary {
  id: ID!
  type: String!
  status: String
  model: String
  metadata: JSON
  messageCount: Int
  previousResponseId: String
  createdAt: Int64!
  updatedAt: Int64!
}

type Interaction {
  id: ID!
  tenantId: String!
  frontdoor: String!
  provider: String!
  appName: String
  requestedModel: String!
  servedModel: String
  providerModel: String
  streaming: Boolean!
  status: String!
  duration: String!
  durationNs: Int64!
  metadata: JSON
  requestHeaders: JSON
  createdAt: Int64!
  updatedAt: Int64!
  
  request: InteractionRequest
  response: InteractionResponse
  error: InteractionError
  transformationSteps: [TransformationStep!]
  shadows: [ShadowResult!]
}

type InteractionRequest {
  raw: JSON
  canonical: JSON
  unmappedFields: [String!]
  providerRequest: JSON
}

type InteractionResponse {
  raw: JSON
  canonical: JSON
  unmappedFields: [String!]
  clientResponse: JSON
  finishReason: String
  usage: Usage
}

type InteractionError {
  type: String!
  code: String
  message: String!
}

type TransformationStep {
  stage: String!
  description: String!
  before: JSON
  after: JSON
}

type Usage {
  inputTokens: Int
  outputTokens: Int
  totalTokens: Int
}

# =============================================================================
# Interaction Events
# =============================================================================

type InteractionEventsResponse {
  interactionId: ID!
  events: [InteractionEvent!]!
}

type InteractionEvent {
  id: ID!
  interactionId: ID!
  stage: String!
  direction: String!
  apiType: String
  frontdoor: String
  provider: String
  appName: String
  modelRequested: String
  modelServed: String
  providerModel: String
  threadKey: String
  previousResponseId: String
  raw: JSON
  canonical: JSON
  headers: JSON
  metadata: JSON
  createdAt: String!
}

# =============================================================================
# Shadow Mode Types
# =============================================================================

type ShadowResultsResponse {
  interactionId: ID!
  shadows: [ShadowResult!]!
}

type ShadowResult {
  id: ID!
  interactionId: ID!
  providerName: String!
  providerModel: String
  request: ShadowRequest
  response: ShadowResponse
  error: ShadowError
  durationNs: Int64!
  tokensIn: Int
  tokensOut: Int
  divergences: [Divergence!]
  hasStructuralDivergence: Boolean!
  createdAt: Int64!
}

type ShadowRequest {
  canonical: JSON
  providerRequest: JSON
}

type ShadowResponse {
  raw: JSON
  canonical: JSON
  clientResponse: JSON
  finishReason: String
  usage: ShadowUsage
}

type ShadowUsage {
  promptTokens: Int
  completionTokens: Int
  totalTokens: Int
}

type ShadowError {
  type: String!
  code: String
  message: String!
}

type Divergence {
  type: DivergenceType!
  path: String!
  description: String!
  primary: JSON
  shadow: JSON
}

enum DivergenceType {
  MISSING_FIELD
  EXTRA_FIELD
  TYPE_MISMATCH
  ARRAY_LENGTH
  NULL_MISMATCH
}

type DivergentShadowsResponse {
  """Interactions with divergent shadow results (these are regular interaction summaries)"""
  interactions: [InteractionSummary!]!
  total: Int!
  limit: Int!
  offset: Int!
}
